<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íšŒì›ê´€ë¦¬</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    .pagination { margin-top: 15px; text-align: center; }
    .pagination button { margin: 0 3px; padding: 5px 10px; }
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #editModal {
      display:none; position:fixed; top:5%; left:10%;
      width:80%; height:85%; overflow-y:scroll;
      background:#fff; border:1px solid #ccc; padding:20px; z-index:1000;
    }

  .cell-changed { color: red; font-weight: 600; }
  /* ì„ íƒ: ëª‡ ì´ˆ í›„ ìƒ‰ìƒ ì›ë³µ ì• ë‹ˆë©”ì´ì…˜ ì›í•˜ë©´ */
  .cell-flash { transition: color 0.6s ease; }


  </style>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h2>íšŒì›ê´€ë¦¬</h2>

  <input type="text" id="searchInput" placeholder="ë‹‰ë„¤ì„/ì´ë©”ì¼ ê²€ìƒ‰" />
  <button onclick="loadMembers(1)">ê²€ìƒ‰</button>

<table>
  <thead>
    <tr>
      <th>ìœ ì € ID</th>
      <th>ë‹‰ë„¤ì„</th>
      <th>ì†Œì…œë‹‰ë„¤ì„</th>
      <th>ì „í™”ë²ˆí˜¸</th>
      <th>ì „í™”ë²ˆí˜¸ ì¸ì¦</th>
      <th>ë“±ê¸‰</th>
      <th>ë“±ê¸‰ ì˜¤ë²„ë¼ì´ë“œ</th>
      <th>ê¶Œí•œ(Role)</th>
      <th>ê°€ì…ì¼</th>
      <th>ìˆ˜ì •ì¼</th>
      <th>Trial ì‹œì‘</th>
      <th>Trial ì¢…ë£Œ</th>
      <th>ì¼ì¼ ì‚¬ìš©ì¼</th>
      <th>ì¼ì¼ ì‚¬ìš© íšŸìˆ˜</th>
      <th>ì¼ì¼ ì œí•œ</th>
      <th>Special ì§€ì •ì¼</th>
      <th>Premium ì§€ì •ì¼</th>
      <th>Premium ìµœì´ˆ ì§€ì •ì¼</th>
      <th>Premium ì‚¬ìš© ì´ë ¥</th>
      <th>ê´€ë¦¬</th>
    </tr>
  </thead>
  <tbody id="memberTable"></tbody>
</table>

<div class="pagination" id="pagination"></div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal">
  <h3>íšŒì› ìˆ˜ì •</h3>
  <form id="editForm">
    <label>ìœ ì € ID: <input type="text" id="edit-user_id" readonly></label><br>
    <label>ë‹‰ë„¤ì„: <input type="text" id="edit-nickname" readonly></label><br>
    <label>ì „í™”ë²ˆí˜¸: <input type="text" id="edit-phone"></label><br>
    <!-- <label>ë“±ê¸‰: <input type="text" id="edit-grade"></label><br> -->
<label>Role:
  <select id="edit-role" onchange="syncGradeWithRole()">
    <option value="normal">ì¼ë°˜</option>
    <option value="premium">ì •ê¸°íšŒì›</option>
    <option value="special">íŠ¹ë³„íšŒì›</option>
    <option value="admin">ê´€ë¦¬ì</option>
  </select>
</label><br>

<label>Grade:
  <select id="edit-grade">
    <option value="basic">ì¼ë°˜</option>
    <option value="premium">ì •ê¸°íšŒì›</option>
    <option value="special">íŠ¹ë³„íšŒì›</option>
    <option value="admin">ê´€ë¦¬ì</option>
  </select>
</label><br>
    <label>Trial ì‹œì‘: <input type="date" id="edit-trial_started_at"></label><br>
    <label>Trial ì¢…ë£Œ: <input type="date" id="edit-trial_ends_at"></label><br>
    <label>ì¼ì¼ ì œí•œ: <input type="number" id="edit-daily_limit"></label><br>
    <label>Special ì§€ì •ì¼: <input type="date" id="edit-special_assigned_at"></label><br>
    <label>Premium ì§€ì •ì¼: <input type="date" id="edit-premium_assigned_at"></label><br>
    <label>Premium ìµœì´ˆ ì§€ì •ì¼: <input type="date" id="edit-premium_first_assigned_at"></label><br>
    <label>Premium ì‚¬ìš© ì´ë ¥:
      <select id="edit-has_ever_premium">
        <option value="true">ì˜ˆ</option>
        <option value="false">ì•„ë‹ˆì˜¤</option>
      </select>
    </label><br><br>

    <button type="button" onclick="saveEdit()">ì €ì¥</button>
    <button type="button" onclick="closeEditModal()">ë‹«ê¸°</button>
  </form>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://dxrgobsgeeshkybkbnxo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cmdvYnNnZWVzaGt5YmtibnhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTAyNzIsImV4cCI6MjA3MzY2NjI3Mn0.vD1xSRezaTC2OUikZZJM7UntQaQWvOxRkvYiMl78UZA"
);

const pageSize = 10;
let currentUserId = null;

// âœ… ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
async function restoreSession() {
  const saved = localStorage.getItem("supabase.auth.session");
  if (saved) {
    try {
      const session = JSON.parse(saved);
      const { data, error } = await supabase.auth.setSession(session);
      console.log("íŒì—… ì„¸ì…˜ ë³µì›:", data, error);
    } catch (e) {
      console.error("ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:", e);
    }
  }
}

window.addEventListener("DOMContentLoaded", async () => {
  await restoreSession();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    window.close();
    return;
  }

  console.log("íŒì—…ì°½ì—ì„œ ë¡œê·¸ì¸ëœ UID:", user.id); // ğŸ‘ˆ íŒì—…ì—ì„œ UID ë¡œê·¸

  // DB role í™•ì¸
  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("user_id", user.id)
    .single();

  if (!profile || profile.role !== "admin") {
    alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    window.close();
    return;
  }

  loadMembers(1);
});




let currentPage = 1;
function renderCell(value, changed) {
  return `<td style="${changed ? 'color:red;' : ''}">${value ?? "-"}</td>`;
}

async function loadMembers(page=1) {
    currentPage = page; // ğŸ‘ˆ í˜„ì¬ í˜ì´ì§€ ì €ì¥
  const search = document.getElementById("searchInput").value;
  const from = (page-1) * pageSize;
  const to = from + pageSize - 1;

  let query = supabase.from("profiles").select("*", { count: "exact" }).range(from, to);
  if (search) {
    query = query.or(`display_name.ilike.%${search}%,nickname.ilike.%${search}%,phone.ilike.%${search}%`);
  }

  const { data, count, error } = await query;
  if (error) { console.error(error); return; }

  const tbody = document.getElementById("memberTable");
  tbody.innerHTML = "";
  data.forEach(member => {
    const tr = document.createElement("tr");
const nicknameEl = document.getElementById("user-nickname");
const currentNickname = nicknameEl ? nicknameEl.textContent : null;
    
    tr.innerHTML = `
      <td>${member.user_id}</td>
      <td>${member.nickname || "-"}</td>
      <td>${member.display_name || "-"}</td>
      <td>${member.phone || "-"}</td>
      <td>${member.phone_verified ? "âœ…" : "âŒ"}</td>
      <td>${member.grade || "-"}</td>
      <td>${member.grade_override || "-"}</td>
      <td>${member.role || "-"}</td>
      <td>${member.created_at ? new Date(member.created_at).toLocaleDateString() : "-"}</td>
      <td>${member.updated_at ? new Date(member.updated_at).toLocaleDateString() : "-"}</td>
      <td>${member.trial_started_at ? new Date(member.trial_started_at).toLocaleDateString() : "-"}</td>
      <td>${member.trial_ends_at ? new Date(member.trial_ends_at).toLocaleDateString() : "-"}</td>
      <td>${member.daily_usage_date || "-"}</td>
      <td>${member.daily_usage_count ?? "-"}</td>
      <td>${member.daily_limit ?? "-"}</td>
      <td>${member.special_assigned_at ? new Date(member.special_assigned_at).toLocaleDateString() : "-"}</td>
      <td>${member.premium_assigned_at ? new Date(member.premium_assigned_at).toLocaleDateString() : "-"}</td>
      <td>${member.premium_first_assigned_at ? new Date(member.premium_first_assigned_at).toLocaleDateString() : "-"}</td>
      <td>${member.has_ever_premium ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"}</td>
      <td>
        <button onclick="openEditModal('${member.user_id}')">ìˆ˜ì •</button>
        <button onclick="deleteMember('${member.user_id}')">ì‚­ì œ</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const totalPages = Math.ceil(count / pageSize);
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  for (let i=1; i<=totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => loadMembers(i);
    if (i === page) btn.disabled = true;
    pagination.appendChild(btn);
  }
}


//ë“±ê¸‰ê³¼ ê¶Œí•œ ë™ì‹œ ìˆ˜ì •
function onRoleChange(userId) {
  const roleSelect = document.getElementById(`role-${userId}`);
  const gradeSelect = document.getElementById(`grade-${userId}`);
  const newRole = roleSelect.value;

  // role ì„ íƒ ì‹œ gradeë¥¼ ê°•ì œë¡œ ë§ì¶”ê¸°
  if (newRole === "normal") gradeSelect.value = "basic";
  if (newRole === "premium") gradeSelect.value = "premium";
  if (newRole === "special") gradeSelect.value = "special";
  if (newRole === "admin")  gradeSelect.value = "premium"; // ê´€ë¦¬ìë„ ì„œë¹„ìŠ¤ í‹°ì–´ëŠ” premium ìœ¼ë¡œ
}


// ëª¨ë‹¬ ì—´ê¸°

async function openEditModal(userId) {
  currentUserId = userId;   // í˜„ì¬ ì„ íƒëœ row id ì €ì¥
  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", userId)
    .single();

  if (error) { alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return; }
  document.getElementById("edit-user_id").value = data.user_id;
  document.getElementById("edit-nickname").value = data.nickname || data.display_name || "";
  document.getElementById("edit-phone").value = data.phone || "";
  document.getElementById("edit-grade").value = data.grade || "";
  document.getElementById("edit-role").value = data.role || "normal";
  document.getElementById("edit-trial_started_at").value = data.trial_started_at ? data.trial_started_at.split("T")[0] : "";
  document.getElementById("edit-trial_ends_at").value = data.trial_ends_at ? data.trial_ends_at.split("T")[0] : "";
  document.getElementById("edit-daily_limit").value = data.daily_limit ?? "";
  document.getElementById("edit-special_assigned_at").value = data.special_assigned_at ? data.special_assigned_at.split("T")[0] : "";
  document.getElementById("edit-premium_assigned_at").value = data.premium_assigned_at ? data.premium_assigned_at.split("T")[0] : "";
  document.getElementById("edit-premium_first_assigned_at").value = data.premium_first_assigned_at ? data.premium_first_assigned_at.split("T")[0] : "";
  document.getElementById("edit-has_ever_premium").value = data.has_ever_premium ? "true" : "false";

  document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

async function saveEdit() {
  const updates = {
    phone: document.getElementById("edit-phone").value,
    grade: document.getElementById("edit-grade").value,
    role: document.getElementById("edit-role").value,
    trial_started_at: document.getElementById("edit-trial_started_at").value
      ? new Date(document.getElementById("edit-trial_started_at").value).toISOString()
      : null,
    trial_ends_at: document.getElementById("edit-trial_ends_at").value
      ? new Date(document.getElementById("edit-trial_ends_at").value).toISOString()
      : null,
    daily_limit: document.getElementById("edit-daily_limit").value || null,
    special_assigned_at: document.getElementById("edit-special_assigned_at").value
      ? new Date(document.getElementById("edit-special_assigned_at").value).toISOString()
      : null,
    premium_assigned_at: document.getElementById("edit-premium_assigned_at").value
      ? new Date(document.getElementById("edit-premium_assigned_at").value).toISOString()
      : null,
    premium_first_assigned_at: document.getElementById("edit-premium_first_assigned_at").value
      ? new Date(document.getElementById("edit-premium_first_assigned_at").value).toISOString()
      : null,
    has_ever_premium: document.getElementById("edit-has_ever_premium").value === "true"
  };

  const { data, error } = await supabase
    .from("profiles")
    .update(updates)
    .eq("user_id", currentUserId)   // ğŸ‘ˆ í˜„ì¬ rowì˜ id ê·¸ëŒ€ë¡œ ì‚¬ìš©
    .select();

    console.log("currentUserId:", currentUserId);

  console.log("ì—…ë°ì´íŠ¸ ì‹œë„:", updates);
  console.log("ì‘ë‹µ:", { data, error });

  if (error) {
    alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
  } else {
    alert("ì €ì¥ ì™„ë£Œ");
    closeEditModal();
    loadMembers(currentPage); // ğŸ‘ˆ í˜„ì¬ í˜ì´ì§€ ê·¸ëŒ€ë¡œ ìƒˆë¡œê³ ì¹¨
  }
}



// ì‚­ì œ
async function deleteMember(userId) {
  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const { data, error } = await supabase
    .from("profiles")
    .delete()
    .eq("user_id", userId)
    .select();

  console.log("ì‚­ì œ ì‹œë„ userId:", userId);
  console.log("ì‚­ì œ ì‘ë‹µ data:", data);
  console.log("ì‚­ì œ ì‘ë‹µ error:", error);

  if (error) {
    alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
    return;
  }

  alert("ì‚­ì œ ì™„ë£Œ");
  // ì„±ê³µ ì‹œ UIì—ì„œë„ ì œê±°
  const row = [...document.querySelectorAll("#memberTable tr")]
    .find(tr => tr.children?.[0]?.textContent.trim() === userId);
  if (row) row.remove();
}

</script>

<!--ìˆ˜ì •ì‚¬í•­ í‘œì‹œ-->
<script>
function fmtDateOrDash(v) {
  if (!v) return "-";
  try { return new Date(v).toLocaleDateString(); } catch { return "-"; }
}
function fmtBoolYN(b) { return b ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"; }
</script>
<script>
function patchAndHighlightRow(userId, updates, options = {clearAfterMs: 3500}) {
  // í•´ë‹¹ í–‰ ì°¾ê¸°(ë§¨ ì²« ì…€ì˜ í…ìŠ¤íŠ¸ê°€ userId ì¸ í–‰)
  const row = [...document.querySelectorAll("#memberTable tr")]
    .find(tr => tr.children?.[0]?.textContent?.trim() === userId);
  if (!row) return;

  // ì…€ í—¬í¼
  const c = idx => row.children[idx];
  const mark = idx => {
    c(idx).classList.add("cell-changed","cell-flash");
    if (options.clearAfterMs) {
      setTimeout(() => c(idx).classList.remove("cell-changed"), options.clearAfterMs);
    }
  };

  // ì—…ë°ì´íŠ¸ëœ í•„ë“œë§Œ ê°’ ë°˜ì˜ + ê°•ì¡°
  if ("phone" in updates) {
    c(3).textContent = updates.phone || "-";
    mark(3);
  }
  if ("grade" in updates) {
    c(5).textContent = updates.grade || "-";
    mark(5);
  }
  if ("grade_override" in updates) {
    c(6).textContent = updates.grade_override || "-";
    mark(6);
  }
  if ("role" in updates) {
    c(7).textContent = updates.role || "-";
    mark(7);
  }
  if ("daily_limit" in updates) {
    c(14).textContent = (updates.daily_limit ?? "-");
    mark(14);
  }
  if ("special_assigned_at" in updates) {
    c(15).textContent = fmtDateOrDash(updates.special_assigned_at);
    mark(15);
  }
  if ("premium_assigned_at" in updates) {
    c(16).textContent = fmtDateOrDash(updates.premium_assigned_at);
    mark(16);
  }
  if ("premium_first_assigned_at" in updates) {
    c(17).textContent = fmtDateOrDash(updates.premium_first_assigned_at);
    mark(17);
  }
  if ("has_ever_premium" in updates) {
    c(18).textContent = fmtBoolYN(updates.has_ever_premium);
    mark(18);
  }

  // ì„ íƒ: ìˆ˜ì •ì¼ ì¹¸(9ë²ˆ)ë„ í˜„ì¬ ì‹œê°ìœ¼ë¡œ í‘œì‹œ/ê°•ì¡°
  c(9).textContent = new Date().toLocaleDateString();
  mark(9);
}
</script>


</body>
</html>
