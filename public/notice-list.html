<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê³µì§€ì‚¬í•­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e6e6e6; --muted:#666; }
    body{ font-family: system-ui, Arial, sans-serif; margin:0; }
    header{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); }
    header h1{ margin:0; font-size:16px; }
    header .spacer{ flex:1 1 auto; }
    header button{ padding:6px 10px; font-size:13px; }
    .wrap{ display:flex; min-height: calc(100vh - 48px); }
    .list{ width: 36%; min-width:280px; border-right:1px solid var(--border); }
    .list ul{ list-style:none; padding:0; margin:0; }
    .list li{ border-bottom:1px solid var(--border); }
    .list a{ display:block; padding:10px 12px; text-decoration:none; color:#1976d2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .list .meta{ padding:0 12px 10px; color:var(--muted); font-size:12px; }
    .detail{ flex:1 1 auto; min-width:0; padding:16px; }
    .detail h2{ margin:0 0 6px; font-size:18px; }
    .detail .meta{ color:var(--muted); font-size:12px; margin-bottom:12px; }
    .detail .content{ white-space:pre-wrap; line-height:1.6; font-size:14px; }
    .actions{ margin-top:14px; display:flex; gap:8px; }
    .empty{ padding:24px; color:#999; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“Œ ê³µì§€ì‚¬í•­</h1>
    <div class="spacer"></div>
    <button id="add-btn" style="display:none;">+ ì¶”ê°€</button>
  </header>

  <div class="wrap">
    <aside class="list">
      <ul id="notice-list">
        <li class="empty">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
      </ul>
    </aside>

    <main class="detail">
      <h2 id="title">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
      <div class="meta" id="meta"></div>
      <div class="content" id="content"></div>
      <div class="actions" id="admin-actions" style="display:none;">
        <button id="edit-btn">ìˆ˜ì •</button>
        <button id="del-btn">ì‚­ì œ</button>
      </div>
    </main>
  </div>

  <script>
    const role = (localStorage.getItem('userRole') || 'normal').toLowerCase();
    const $list = document.getElementById('notice-list');
    const $title = document.getElementById('title');
    const $meta  = document.getElementById('meta');
    const $content = document.getElementById('content');
    const $actions = document.getElementById('admin-actions');
    const $addBtn = document.getElementById('add-btn');
    const $editBtn = document.getElementById('edit-btn');
    const $delBtn = document.getElementById('del-btn');

    // ê´€ë¦¬ì ë²„íŠ¼ ë…¸ì¶œ
    if (role === 'admin') {
      $addBtn.style.display = 'inline-block';
      $actions.style.display = 'flex';
    }

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
    function qs(name){
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }

    let notices = [];
    let currentId = parseInt(qs('id') || '0', 10) || null;

    async function loadList() {
      $list.innerHTML = '<li class="empty">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
      try {
        const res = await fetch('/api/notice');
        const data = await res.json();
        notices = Array.isArray(data) ? data : [];
        renderList();
        // ì²˜ìŒ ë“¤ì–´ì™”ê³  id ì—†ìœ¼ë©´ ì²« í•­ëª© ìë™ ì„ íƒ
        if (!currentId && notices.length) {
          select(notices[0].id);
        } else if (currentId) {
          select(currentId);
        }
      } catch (e) {
        console.error(e);
        $list.innerHTML = '<li class="empty">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
      }
    }

    function renderList() {
      if (notices.length === 0) {
        $list.innerHTML = '<li class="empty">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      $list.innerHTML = '';
      for (const n of notices) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.textContent = n.title;
        a.href = 'javascript:void(0)';
        a.onclick = () => select(n.id);
        li.appendChild(a);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${new Date(n.created_at).toLocaleDateString()} Â· ì¡°íšŒ ${n.views}`;
        li.appendChild(meta);

        $list.appendChild(li);
      }
    }

    async function select(id) {
      currentId = id;
      history.replaceState(null, '', `?id=${id}`);
      try {
        const res = await fetch(`/api/notice/${id}`);
        if (!res.ok) throw new Error('ìƒì„¸ ì½ê¸° ì‹¤íŒ¨');
        const n = await res.json();
        $title.textContent = n.title;
        $meta.textContent = new Date(n.created_at).toLocaleString() + ` Â· ì¡°íšŒ ${n.views}`;
        $content.textContent = n.content ?? '';

        // ë²„íŠ¼ ë™ì‘ ê°±ì‹ 
        if (role === 'admin') {
          $editBtn.onclick = async () => {
            const curTitle = prompt('ìƒˆ ì œëª©:', n.title);
            if (curTitle === null) return;
            const curContent = prompt('ìƒˆ ë‚´ìš©:', n.content ?? '');
            if (curContent === null) return;

            const resp = await fetch(`/api/notice/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title: curTitle.trim(), content: (curContent ?? '').trim() })
            });
            if (!resp.ok) { alert('ìˆ˜ì • ì‹¤íŒ¨'); return; }
            await loadList();        // ëª©ë¡/ìƒì„¸ ëª¨ë‘ ê°±ì‹ 
            select(id);
            alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          };

          $delBtn.onclick = async () => {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const resp = await fetch(`/api/notice/${id}`, { method: 'DELETE' });
            if (!resp.ok) { alert('ì‚­ì œ ì‹¤íŒ¨'); return; }
            await loadList();
            // ì‚­ì œ í›„ ì²« í•­ëª© ì„ íƒ
            if (notices.length) select(notices[0].id);
            else {
              $title.textContent = 'í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”';
              $meta.textContent = '';
              $content.textContent = '';
              history.replaceState(null, '', location.pathname);
            }
          };
        }
      } catch (e) {
        console.error(e);
        $title.textContent = 'ì½ê¸° ì‹¤íŒ¨';
        $meta.textContent = '';
        $content.textContent = '';
      }
    }

    // ì¶”ê°€ ë²„íŠ¼
    $addBtn?.addEventListener('click', async () => {
      const title = prompt('ìƒˆ ê³µì§€ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (title === null) return;
      const content = prompt('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (content === null) return;

      const resp = await fetch('/api/notice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: title.trim(), content: (content ?? '').trim() })
      });
      if (!resp.ok) { alert('ë“±ë¡ ì‹¤íŒ¨'); return; }
      await loadList();
      // ë°©ê¸ˆ ì¶”ê°€í•œ ìµœì‹ ì„ ì„ íƒ
      if (notices.length) select(notices[0].id);
    });

    loadList();
  </script>
</body>
</html>
