<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>결제 처리</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Pretendard,Arial,sans-serif;
         padding:18px; line-height:1.5}
    .ok{color:#0a7d28} .err{color:#b00020}
  </style>
</head>
<body>
  <h1>결제 처리</h1>
  <p id="msg">결제 결과 확인 중입니다…</p>

<script>
(async function () {
  const msg = document.getElementById('msg');
  const q = new URLSearchParams(location.search);

  // ✅ 공용 에러 토스트(401 등) 잠시 끄기 — 전역 인터셉터가 있어도 억제
  window.__inPaymentFlow = true;
  window.__suppressAuthToast = true;

  // PortOne 기본 파라미터
  const imp_uid      = q.get('imp_uid');
  const merchant_uid = q.get('merchant_uid');
  const success      = q.get('imp_success') ?? q.get('success');

  // 우리가 추가로 붙인 힌트(선택)
  const provider     = (q.get('provider') || '').toLowerCase(); // 'kakaopay' 등
  const kind         = (q.get('kind') || '').toLowerCase();     // 'recurring_start' | 'fixed'
  const tier         = q.get('tier');                           // 'premium' | 'premium_plus'
  const customer_uid = q.get('customer_uid');
  const monthsParam  = q.get('months');
  const productId    = q.get('productId');

  if (!imp_uid && !merchant_uid) {
    msg.className = 'err';
    msg.textContent = '잘못된 접근: 결제 식별자가 없습니다.';
    return;
  }

  // 프론트 가격 표 (선결제 금액 계산용 — 서버는 SRK로 재검증)
  const PRICE = { premium: 11000, premium_plus: 16500, premium3: 60000, premium6: 100000 };
  const toPlanName = (m) => (Number(m) === 6 ? 'premium6' : 'premium3');

  try {
    // ❌ 세션(ID) 조회 제거: 모바일 리다이렉트 컨텍스트에선 종종 쿠키가 없음
    // const user_id = await getUserId();

    let endpoint = '/api/payment/manage-subscription?action=auto_verify';
    let payload  = { imp_uid, merchant_uid: merchant_uid || null, success };

    if (provider === 'kakaopay' && kind === 'recurring_start') {
      if (!customer_uid) throw new Error('customer_uid 가 없습니다.');
      // ✅ user_id 미전송 — 서버가 customer_uid ↔ user 매핑 테이블로 식별
      endpoint = '/api/payment/manage-subscription?action=register';
      payload  = { imp_uid, customer_uid, tier: (tier === 'premium_plus' ? 'premium_plus' : 'premium') };
    } else if (provider === 'kakaopay' && kind === 'fixed') {
      const termMonths = Number(monthsParam || 0);
      if (!termMonths || (termMonths !== 3 && termMonths !== 6)) {
        throw new Error('months 파라미터가 올바르지 않습니다(3 또는 6).');
      }
      endpoint = '/api/payment/manage-subscription?action=activate_fixed';
      const planName = toPlanName(termMonths);
      const price    = PRICE[planName];
      payload = {
        imp_uid,
        merchant_uid: merchant_uid || null,
        termMonths,
        price,
        ...(productId ? { productId } : {})
      };
    }

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      // ✅ 세션 쿠키 미동봉 (엔드포인트는 SRK로 자체 인증)
      credentials: 'omit',
      body: JSON.stringify(payload)
    });

   const raw = await res.text();
 let data = {};
 try { data = JSON.parse(raw); } catch {}
 console.log('[complete] status=', res.status, 'raw=', raw);


    if (res.ok) {
      msg.className = 'ok';
      msg.textContent = '✅ 결제가 완료되었습니다. 구독이 갱신되었어요!';
      setTimeout(() => {
        try { window.opener?.location?.reload(); } catch {}
        location.replace('/');
      }, 800);
    } else {
      msg.className = 'err';
      msg.textContent = '❌ 결제 확인 실패: ' + (data?.error || res.status) + (data?.detail ? (' / ' + JSON.stringify(data.detail)) : '');
    }

  } catch (e) {
    msg.className = 'err';
    // 여기 메시지가 바로 “처리중 오류: …” 로 보입니다
    msg.textContent = '❌ 처리 중 오류: ' + (e?.message || e);
  } finally {
    // 결제 플로우 토스트 억제 해제
    window.__inPaymentFlow = false;
    window.__suppressAuthToast = false;
  }
})();
</script>
</body>
</html>
