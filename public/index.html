 <!-- //         git add .
//               git commit -m "로그인횟수제한"   
//               git push origin main
//               git push
//               강제실행   vercel --prod --force
-->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />

<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet" />


<title>트리 만세력</title>
  <!-- Supabase SDK -->
  <!-- (바꾼 후) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  
 <!-- 2) Supabase 초기화 (전역 등록) -->
<script>
  if (!window.supabase) {
    alert("Supabase SDK 로드 실패. 네트워크 또는 CDN 경로를 확인하세요.");
  }

  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  const isMobile = /android|iphone|ipad|ipod/i.test(userAgent);

  window.supabaseClient = window.supabase.createClient(
    "https://dxrgobsgeeshkybkbnxo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cmdvYnNnZWVzaGt5YmtibnhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTAyNzIsImV4cCI6MjA3MzY2NjI3Mn0.vD1xSRezaTC2OUikZZJM7UntQaQWvOxRkvYiMl78UZA",
    {
      auth: {
        storage: isMobile ? window.localStorage : window.sessionStorage,
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
      },
    }
  );

  // 호환용
  window.client = window.supabaseClient;
  console.log("[INDEX] supabaseClient ready:", !!window.supabaseClient);
</script>


<style>
  body {
    font-family: 'Nanum Gothic', sans-serif;
    margin: 0; padding: 0;
    background-color: #f8f8f8;
  }

  /* 덩굴 테두리 컨테이너 전체 감싸기 */
.vine-border-container {
  position: relative;
  display: inline-block;   /* ✅ 내용 크기만큼만 박스 크기 */
  padding: 40px;
  max-width: 100%;       /* ✅ 화면 전체 폭까지 가능 */
  width: auto;           /* ✅ 내용 크기에 맞게 기본은 auto */
  margin: 40px auto 80px auto;
  background-color: transparent;
  border: none;
  border-radius: 0;
  overflow: visible;     /* 넝쿨 이미지가 영역 밖에 있을 수 있게 */
}

  /* 흐릿한 배경 (내용 전체 배경 역할) */
  .text-bg {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    z-index: 1;
    pointer-events: none;
  }

/* 덩굴 이미지 4모서리 */
.vine-deco {
  position: absolute;
  width: 150px; 
  height: 150px;
  background-image: url('/images/vine.png');
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 1;
  pointer-events: none;   /* 입력 가리지 않음 */
  z-index: 9999;          /* ✅ 덩굴을 항상 맨 위로 */
}

.vine-top-left {
  top: 0; left: 0;
  transform: rotate(180deg);
}
.vine-top-right {
  top: 0; right: 0;
  transform: scaleX(-1) rotate(180deg);
}
.vine-bottom-left {
  bottom: 0; left: 0;
  transform: scaleY(-1) rotate(180deg);
}
.vine-bottom-right {
  bottom: 0; right: 0;
  transform: scaleX(-1) scaleY(-1) rotate(180deg);
}

/* 내부 콘텐츠 영역 - 덩굴보다 뒤에 위치 */
.vine-border-container > *:not(.text-bg):not(.vine-deco) {
  position: relative;
  z-index: 1;   /* ✅ 덩굴보다 낮게 */
}

  /* 제목, 폼 스타일 */
  h1 {
    margin-top: 0;
    color: #222;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.25);
  }

  form#saju-form {
    margin-top: 20px;
  }

  /* 결과 및 질문 박스 스타일 */
  #result,
  #sewoon,
  #today-saju-container,
  #question-box {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 15px;
    margin-top: 20px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    color: #222;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }

  /* 테이블 스타일 (결과 내부 테이블용) */
  #result table,
  #sewoon table,
  #today-saju-container table {
    width: 100%;
    border-collapse: collapse;
  }
  #result table th,
  #result table td,
  #sewoon table th,
  #sewoon table td,
  #today-saju-container table th,
  #today-saju-container table td {
    padding: 8px 12px;
    border: 1px solid #ccc;
    background-color: transparent;
    color: #222;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
  }
.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-success:hover {
  background-color: #218838;
}
.sewoon-cell.selected {
  background-color: #dff0d8; /* 연한 연두색 */
  border: 2px solid #28a745;
  box-shadow: 0 0 4px rgba(40,167,69,0.5);
}

  .green { color: green; font-weight: bold; }
  .red { color: red; font-weight: bold; }

    #sinsal-box table td {
      text-align: center;
      vertical-align: middle;
    }

#sinsal-box table {
  margin-left: auto;
  margin-right: auto;
}

#basic-section, #sinsal-section {
  display: none;
}



.tooltip {
  position: relative;
  cursor: pointer;
}

.tooltip::after {
  content: attr(data-desc);
  position: absolute;
  background: #333;
  color: #fff;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 13px;
  z-index: 9999;

  /* 여러 줄 출력 가능 */
  white-space: normal;
  word-break: keep-all;   /* 단어 단위 줄바꿈 (띄어쓰기 기준) */
  max-width: 600px;       /* 줄바꿈 발생할 최대 폭 */
  line-height: 1.5;
  text-align: left;

  /* 위치: 요소 위쪽 중앙 */
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);

  display: block;         /* ✅ 세로 한줄 문제 방지 */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.tooltip:hover::after {
  opacity: 1;
}

.nackhwa-table {
  border-collapse: collapse !important;   /* ✅ 상위 테이블 속성 무시 */
  width: 100%;
}

.nackhwa-table td,
.nackhwa-table th {
  border: 1px solid #999 !important;      /* ✅ 내부 칸 선 강제 표시 */
  padding: 2px;
}

      .parent #nackhwaPopup .nackhwa-table td,
.parent #nackhwaPopup .nackhwa-table th {
  border: 1px solid #999 !important;
}

#nackhwaPopup {
  width: auto !important;      /* ✅ 자동 크기 */
  min-width: unset !important; /* ✅ 기본 제한 해제 */
  max-width: none !important;  /* ✅ 최대폭 제한 해제 */
  height: auto !important;     /* ✅ 높이도 자동 */
  white-space: nowrap;         /* ✅ 줄바꿈 방지 */
}

.btn-success.active {
  background-color: #f18997; 
  color: #fff;
}

/* 고객 이력 표 전체 */
#saju-history-table {
  width: 100%;
  border-collapse: collapse; /* 이중선 제거 */
  font-size: 14px;
  margin-top: 10px;
}

/* 셀 공통 스타일 */
#saju-history-table th,
#saju-history-table td {
  border: 1px solid #e0e0e0;
  padding: 8px 12px;
  text-align: center;
}

/* 헤더 줄 */
#saju-history-table th {
  background-color: #f8f9fa;
  font-weight: bold;
}

/* 줄무늬 효과 */
#saju-history-table tr:nth-child(even) {
  background-color: #fcfcfc;
}

/* hover 효과 */
#saju-history-table tr:hover {
  background-color: #f1f7ff;
}

/* 이름 클릭 링크 */
.saju-record-link {
  cursor: pointer;
  color: #007bff;
  text-decoration: underline;
}

/* 삭제 버튼 */
.delete-record-btn {
  background: #ff4d4f;
  border: none;
  color: white;
  padding: 5px 10px;
  font-size: 12px;
  border-radius: 4px;
  cursor: pointer;
}
.delete-record-btn:hover {
  background: #d9363e;
}




#page-info {
  margin-top: 12px;
  text-align: center;   /* ✅ 전체 가운데 정렬 */
}

.page-btn,
.page-num {
  margin: 0 2px;          /* ✅ 간격 줄임 */
  padding: 2px 4px;       /* ✅ 안쪽 여백도 줄임 */
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: #000;            /* 기본 검정색 */
}

.page-btn:hover,
.page-num:hover {
  text-decoration: underline;
}

.page-num.active {
  font-weight: bold;
  color: red;             /* ✅ 현재 페이지만 빨강 */
  text-decoration: none;
}


  /* 공지 1줄: 길면 말줄임 */
.notice-bar{
  display:flex; align-items:center;
  padding:8px 12px; border:1px solid #eee; background:#fff; font-size:14px;
}
.notice-bar .label{ flex:0 0 auto; }
.notice-bar .title{
  flex:1 1 auto; min-width:0;               /* ← 핵심: 공간 최대 활용 */
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
#latest-notice,
#latest-notice:visited {
  color: #1976d2 !important;
  text-decoration: none;
}

  /* 가로 메뉴 기본 스타일 */
  .top-menu{
    margin-top:8px;
    border:1px solid #eee;
    background:#fafafa;
    padding:6px 10px;
    font-size:14px;
  }
  .top-menu ul{
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    align-items:center;
    flex-wrap:wrap;
    gap:0; /* 항목 사이 간격은 구분자에서 처리 */
  }
  .top-menu li{
    display:inline-block;
  }
  .top-menu li + li::before{
    content:"|";
    color:#aaa;
    margin:0 8px;
  }
  .top-menu a{
    text-decoration:none;   /* 밑줄 제거 */
    color:#333;
  }
  .top-menu a:hover{
    text-decoration:underline; /* 원하면 제거해도 됨 */
  }


    .notice-inline{
    display:flex; align-items:center; gap:6px;
    padding:8px 12px; border:1px solid #eee; background:#fff; 
    white-space:nowrap; overflow:hidden;
  }
  .notice-title{ flex:1; min-width:0; }           /* 말줄임 가능한 영역 */
  .notice-title ul{ margin:0; padding:0; list-style:none; }
  .notice-title li{ display:block; }              /* 스크립트가 li를 채움 */
  .notice-title a{
    display:block; text-decoration:none; color:#333;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }

/* 접힌 상태 (완전 숨김) */
#profile-edit-panel{
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  padding: 0 !important;          /* ← 한 줄 잔상 제거 핵심 */
  border-width: 0 !important;     /* ← 테두리도 제거 */
  margin-top: 0 !important;       /* ← 위 여백 제거 */
  pointer-events: none;

  /* 부드러운 전환 */
  transition:
    max-height .25s ease,
    padding .2s ease,
    margin .2s ease,
    opacity .2s ease,
    border-width .2s ease;
}

/* 펼친 상태만 보이게 */
#profile-edit-panel.open{
  max-height: 420px;
  opacity: 1;
  padding: 12px !important;
  border: 1px solid #ddd !important;
  margin-top: 12px !important;
  pointer-events: auto;
  background: #fafafa;            /* 필요 시 유지 */
  border-radius: 8px;             /* 필요 시 유지 */
}

</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">



<!-- 2. flatpickr JS (★ 먼저 불러와야 함) -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


</head>
<body>

<!-- 덩굴 테두리 컨테이너가 페이지 내용 전체 감싸기 -->
<div class="vine-border-container">
  <div class="text-bg"></div>

  <div class="vine-deco vine-top-left"></div>
  <div class="vine-deco vine-top-right"></div>
  <div class="vine-deco vine-bottom-left"></div>
  <div class="vine-deco vine-bottom-right"></div>












 <!-- 레이아웃: 1행 2칸 테이블 -->
<table style="width:500px; border-collapse:collapse; table-layout:fixed;">
  <colgroup>
    <col style="width: 1fr;">
    <col style="width: 240px;"> <!-- 우측 메뉴 폭 -->
  </colgroup>
  <tr>
    <th colspan="2" style="text-align:left; padding:16px 0; font-size:28px;">
      트리 만세력
    </th>
  </tr>
  <tr>



<!-- 가로 메뉴: 밑줄 제거 + 구분자 자동 -->
<nav class="top-menu">
  <ul>
    <li><a href="/index.html">공지게시판</a></li>
<li>
  <a href="javascript:void(0)"
     onclick="window.open('https://cafe.naver.com/f-e/cafes/22418538/menus/288?t=1758692524163',
                          'free',
                          'width=1200,height=800,scrollbars=yes')">
     소통창
  </a>
</li>


<li>
  <a href="javascript:void(0)"
     onclick="window.open('https://cafe.naver.com/f-e/cafes/22418538/menus/327?t=1758693680522',
                          'faq',
                          'width=1200,height=800,scrollbars=yes')">
     FAQ
  </a>
</li>

<li>
  <a href="javascript:void(0)"
     onclick="window.open('https://cafe.naver.com/f-e/cafes/22418538/menus/328?t=1758693700672',
                          'contact',
                          'width=1200,height=800,scrollbars=yes')">
     문의하기
  </a>
</li>

<li><a id="admin-menu" href="javascript:void(0)" 
       onclick="window.open('/member-admin.html','memberAdmin','width=1400,height=800,scrollbars=yes')" 
       style="display:none;">
  회원관리
</a></li>


  </ul>
</nav>



  </tr>
</table>





<div class="notice-inline">
  <strong>📌 공지사항:&nbsp;</strong>
  <div class="notice-title">
    <ul id="notice-list"></ul> <!-- 기존 스크립트가 여기 채움 (최신 1개) -->
  </div> <button id="add-btn" style="display:none;">공지 추가</button>
</div>
<!-- 로그인/로그아웃 영역 -->
<div id="auth-section" class="auth-section" style="margin-top:20px;">
  <form id="login-form">
    <table class="auth-table">
      <tr>
        <!-- 이메일 입력 -->
        <td>
          <input type="email" id="email" placeholder="이메일" style="padding:5px; width:120px;">
        </td>
        <!-- 로그인 / 회원가입 -->
        <td>
            <input type="password" id="password" placeholder="비밀번호" style="padding:5px; width:60px;">
          <button type="button" id="loginBtn" class="btn-success">로그인</button>
          <button type="button" id="signupBtn" class="btn-success" style="margin-left:8px; background-color:#fab7b7; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">회원가입</button>
        </td>
      </tr>
      <tr>
        <!-- 비밀번호 입력 -->
<td style="text-align: right; color: blue;">
  간편로그인:
</td>


  <td>
  <div class="social-login">
    <!-- 구글 로그인 버튼 -->
    <img src="images/구글로그인.png" 
         alt="Google 로그인" 
         class="login-btn" 
         id="googleLogin" />

    <!-- 카카오 로그인 버튼 -->
    <img src="images/카카오로그인.png" 
         alt="Kakao 로그인" 
         class="login-btn" 
         id="kakaoLogin" />
  </div>
</td>

      </tr>
    </table>
  </form>
</div>

<!-- 로그인 후 표시 -->
<div id="profile-section" style="display:none; margin-top:8px;">
  <span id="user-nickname" style="font-weight:600; color: blue;"></span> 님 환영합니다
 
  <button id="logoutBtn" type="button" style="margin-left:8px; background-color:#fab7b7; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">로그아웃</button>
   <!-- 회원정보 수정 버튼 -->
  <button id="editProfileBtn" type="button" style="margin-left:8px;">
    회원정보 수정
  </button>

  <!-- 드롭(슬라이드) 패널: 프로필 수정 -->
<!-- 드롭(슬라이드) 패널: 프로필 수정 -->
<div id="profile-edit-panel" class="collapse" aria-hidden="true"
     style="display:none; margin-top:12px; padding:12px; border:1px solid #ddd; border-radius:8px; background:#fafafa;">
  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;">
 <label style="display:flex; flex-direction:column;">
  <span>닉네임</span>
  <input id="my-nickname" type="text" placeholder="닉네임" style="margin-top:6px;">
</label>


    <label style="display:flex; flex-direction:column;">
      <span>이메일</span>
      <input id="my-email" type="email" placeholder="you@example.com" style="margin-top:6px;" readonly>
    </label>

    <label style="display:flex; flex-direction:column;">
      <span>전화번호</span>
      <input id="my-phone" type="tel" placeholder="010-1234-5678" style="margin-top:6px;">
    </label>

    <div style="min-width:140px;">
      <div><strong>회원등급</strong> : <span id="my-grade">-</span></div>
      <div><strong>1일 카운트</strong> : <span id="my-daily-count">-</span></div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <button id="my-profile-save"   type="button" style="background:#3b82f6; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">저장</button>
    <button id="my-profile-cancel" type="button" style="margin-left:6px; border:1px solid #ddd; padding:6px 10px; border-radius:6px; cursor:pointer;">닫기</button>
  </div>
</div>

  <br>
  <button id="toggle-history-btn" style="background-color:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">고객data</button>
  <button id="subscribeBtn" type="button" style="margin-left:8px;background-color:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">정기구독</button>


<!-- 패널 (처음엔 숨김) -->
<div id="saju-history-panel" style="display:none; margin-top:10px;">
  <!-- 검색 -->
  <div>
    <input type="text" id="search-name" placeholder="이름 검색" style="background-color:#f7f4df; border:1px solid #ccc; padding:5px; border-radius:4px; width:60px;">
    <button id="search-btn" style="background-color:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">검색</button>
  </div>

  <!-- 테이블 -->
  <table border="1" width="100%" id="saju-history-table">
    <thead>
      <tr>
        <th>이름</th>
        <th>생년월일</th>
        <th>성별</th>
        <th>등록일</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 페이지 컨트롤 -->
  <div style="margin-top:10px;">
    <button id="prev-page">이전</button>
    <span id="page-info">페이지 1</span>
    <button id="next-page">다음</button>
  </div>
</div>


</div>

<!-- 결제 모달 -->
<div id="subscriptionModal" style="display:none; margin-top:20px; border:1px solid #ccc; padding:16px;">
  <h3>정기구독 결제</h3>
  <p>전화번호 인증이 완료되었습니다. 결제 방법을 선택하세요.</p>
  <button onclick="startGoogleSubscription()">Google 정기구독 결제</button>
  <button onclick="startKakaoSubscription()">Kakao 정기구독 결제</button>
</div>











    <form id="saju-form">
      <label>고객명:</label>
<input type="text" id="customer-name" placeholder="저장관리용" style="background-color:#f7f4df; border:1px solid #ccc; padding:5px; border-radius:4px; width:60px;" />
 <label for="gender">성별:</label>
<select id="gender">
  <option value="">선택</option>
  <option value="male" >남자</option>
  <option value="female">여자</option>
</select>
<button id="reset-btn" type="button" style="margin-left:8px; background-color:#fcfdd0; color:rgb(5, 1, 1); border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" >다시입력</button>
<br />

    <label>생년월일:</label> 
    <input  type="text" id="birth-date" placeholder="YYYYMMDD" class="birthdate-input" style="background-color:#f7dff5; border:1px solid #ccc; padding:5px; border-radius:4px; width:80px;"/>

    
    <select id="calendar-type" name="calendar-type">
      <option value="">선택</option>
                                    <option value="solar"  >양력</option>
      <option value="lunar">음력</option>
    </select>

<br />

    <label>출생 시간:</label>
                         <label><input type="radio" name="ampm" value="AM"> 오전</label>
    <label><input type="radio" name="ampm" value="PM"> 오후</label>
    <label>+</label>
    <select id="hour-select">
      <option value="선택"></option>
       <option value="0">0시</option>
      <option value="1">1시</option>
      <option value="2">2시</option>
                                    <option value="3" >3시</option>
      <option value="4">4시</option>
      <option value="5">5시</option>
      <option value="6">6시</option>
      <option value="7">7시</option>
      <option value="8" >8시</option>
      <option value="9">9시</option>
      <option value="10">10시</option>
      <option value="11">11시</option>
    </select>
<select id="minute-select">
  <option value="선택"></option>
  <option value="0">0분</option>
  <option value="1">1분</option>
  <option value="2">2분</option>
  <option value="3">3분</option>
  <option value="4">4분</option>
  <option value="5">5분</option>
  <option value="6">6분</option>
  <option value="7">7분</option>
  <option value="8">8분</option>
  <option value="9">9분</option>
                             <option value="10"  >10분</option>
  <option value="11">11분</option>
  <option value="12">12분</option>
  <option value="13">13분</option>
  <option value="14">14분</option>
  <option value="15">15분</option>
  <option value="16">16분</option>
  <option value="17">17분</option>
  <option value="18">18분</option>
  <option value="19">19분</option>
  <option value="20">20분</option>
  <option value="21">21분</option>
  <option value="22">22분</option>
  <option value="23">23분</option>
  <option value="24">24분</option>
  <option value="25">25분</option>
  <option value="26">26분</option>
  <option value="27">27분</option>
  <option value="28">28분</option>
  <option value="29">29분</option>
  <option value="30">30분</option>
  <option value="31">31분</option>
  <option value="32">32분</option>
  <option value="33">33분</option>
  <option value="34">34분</option>
  <option value="35">35분</option>
  <option value="36">36분</option>
  <option value="37">37분</option>
  <option value="38">38분</option>
  <option value="39">39분</option>
  <option value="40">40분</option>
  <option value="41">41분</option>
  <option value="42">42분</option>
  <option value="43">43분</option>
  <option value="44">44분</option>
  <option value="45">45분</option>
  <option value="46">46분</option>
  <option value="47">47분</option>
  <option value="48">48분</option>
  <option value="49">49분</option>
  <option value="50">50분</option>
  <option value="51">51분</option>
  <option value="52">52분</option>
  <option value="53">53분</option>
  <option value="54">54분</option>
  <option value="55">55분</option>
  <option value="56">56분</option>
  <option value="57">57분</option>
  <option value="58">58분</option>
  <option value="59">59분</option>
</select><br />

  <!-- 기존 버튼 -->
  <button type="button" id="sajuSubmit" class="btn-success">사주식 출력</button>
  <button type="button" id="sinsalBtn" class="btn-success">신살보기</button>
<span id="count-display"></span>
 
  </form>




<div class="note-box">
  ※ 태어난 분대가 20~40분(30분 근처)에 있는 분은 정확한 시주가 <br>산출되지 않을 수도 있으니 따로 확인해 주세요! <br>한국썸머타임은 적용된 상태입니다. 
</div>
<div id="result" style="display:none;">

<!-- 공통 (항상 표시) -->
<div id="common-section">
  <div id="birth-info"></div>
  <div id="ganji-table"></div>
  <div id="today-saju-container" style="margin-top:30px;"></div>
</div>

<!-- 기본 모드 -->
<div id="basic-section" style="display:none;">
  <div id="dangryeong-table" class="dangryeong-table"></div>

  <!-- ✅ basic 전용 대운/세운 -->
  <div id="basic-daeyun-table" class="daeyun-table-container"></div>

</div>

<!-- 신살류 모드 -->
<div id="sinsal-section" style="display:none;">
  <!-- ✅ sinsal 전용 대운/세운 -->
  <div id="sinsal-daeyun-table" class="daeyun-table-container"></div>
  

  <div id="sinsal-box"></div>
  <div id="etc-sinsal-box"></div>
</div>




  <div id="question-box" style="margin-top: 40px; padding: 20px; border-top: 1px solid #ccc;">
    <h3>질문하기</h3>
    <textarea id="question-input" placeholder="궁금한 점을 문의하세요...(반드시 사주출력후 질문하세요)" rows="8" style="width: 100%; padding: 10px;"></textarea>
    <br />
    <button id="send-email-button" style="margin-top: 10px; padding: 10px 20px;">보내기 (이메일)</button>
  </div>
</div>

  <div id="container"></div>  <!-- ✅ 여기에 출력 -->
<!-- EmailJS SDK 추가 -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script type="module" src="/app.js?v=20250929-03"></script>

<script>
  const buttons = document.querySelectorAll("#sajuSubmit, #sinsalBtn");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      // 모든 버튼에서 active 제거
      buttons.forEach(b => b.classList.remove("active"));
      // 클릭된 버튼에 active 추가
      btn.classList.add("active");
    });
  });
</script>





<!-- 공지사항 게시판 -->

<script>
  const supabase = window.supabaseClient;

  // 토큰/롤 헬퍼
  const getToken = () =>
    localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
  const getRole = () =>
    (localStorage.getItem('userRole') || 'normal').toLowerCase();

  // 공지 목록 렌더 (최신 1개만)
  async function renderNotices() {
    const res = await fetch('/api/notice');
    const data = await res.json();

    const list = document.getElementById('notice-list');
    const addBtn = document.getElementById('add-btn');
    const role = getRole();

    // 버튼 표시/숨김
    if (addBtn) addBtn.style.display = role === 'admin' ? 'inline' : 'none';

    list.innerHTML = '';

    // 최신 1개만
    const n = Array.isArray(data) && data.length ? data[0] : null;
    if (!n) {
      const li = document.createElement('li');
      li.textContent = '등록된 공지가 없습니다.';
      list.appendChild(li);
      return;
    }

    const li = document.createElement('li');
    li.innerHTML = `<a href="javascript:void(0)" onclick="openNotice(${n.id})">${n.title}</a>`;

    if (role === 'admin') {
      li.innerHTML += `
        <button onclick="editNotice(${n.id})">수정</button>
        <button onclick="deleteNotice(${n.id})">삭제</button>
      `;
    }

    list.appendChild(li);
  }

  // 팝업으로 공지 상세 열기
  function openNotice(id) {
    window.open(
      `/notice.html?id=${id}`,
      'noticePopup',
      'width=600,height=400,resizable=yes,scrollbars=yes'
    );
  }

  // 공지 추가 (제목+내용)
  document.getElementById('add-btn')?.addEventListener('click', async () => {
    const title = prompt('새 공지의 제목을 입력하세요:');
    if (title === null) return;
    const content = prompt('내용을 입력하세요:\n(줄바꿈 가능)');
    if (content === null) return;

    const newTitle = title.trim();
    const newContent = (content ?? '').trim();
    if (!newTitle || !newContent) {
      alert('제목과 내용을 모두 입력하세요.');
      return;
    }

    const token = getToken();
    const resp = await fetch('/api/notice', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {})
      },
      body: JSON.stringify({ title: newTitle, content: newContent })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      alert(err.error || '공지 추가 실패(권한 또는 서버 오류)');
      return;
    }

    renderNotices();
  });

  // 공지 수정: 제목+내용 모두 변경
  async function editNotice(id) {
    // 현재 데이터 조회
    const cur = await fetch(`/api/notice/${id}`).then(r => r.json());
    if (!cur || !cur.id) {
      alert('공지 정보를 불러오지 못했습니다.');
      return;
    }

    const title = prompt('새 제목을 입력하세요:', cur.title || '');
    if (title === null) return;

    const content = prompt('새 내용을 입력하세요:\n(줄바꿈 가능)', cur.content || '');
    if (content === null) return;

    const newTitle = title.trim();
    const newContent = (content ?? '').trim();
    if (!newTitle || !newContent) {
      alert('제목과 내용을 모두 입력하세요.');
      return;
    }

    const token = getToken();
    const resp = await fetch(`/api/notice/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {})
      },
      body: JSON.stringify({ title: newTitle, content: newContent })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      alert(err.error || '공지 수정 실패(권한 또는 서버 오류)');
      return;
    }

    renderNotices();
  }

  // 공지 삭제
  async function deleteNotice(id) {
    if (!confirm('정말 삭제하시겠습니까?')) return;

    const token = getToken();
    const resp = await fetch(`/api/notice/${id}`, {
      method: 'DELETE',
      headers: {
        ...(token ? { Authorization: `Bearer ${token}` } : {})
      }
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      alert(err.error || '공지 삭제 실패(권한 또는 서버 오류)');
      return;
    }

    renderNotices();
  }

  // 로그인 UI 업데이트 (role 저장/삭제 및 버튼 상태 반영)
  async function updateAuthUI(session) {
    const authSection =
      document.getElementById('auth-section') ||
      document.getElementById('login-form') ||
      document.querySelector('.login-form');
    const profileSection = document.getElementById('profile-section');
    const nicknameEl = document.getElementById('user-nickname');
    const historySection = document.getElementById('saju-history-section');

    if (session && session.user) {
      const token = session.access_token;
      const isMobile = /android|iphone|ipad|ipod/i.test(
        navigator.userAgent || ''
      );

      if (isMobile) localStorage.setItem('authToken', token);
      else sessionStorage.setItem('authToken', token);

      if (authSection) authSection.style.display = 'none';
      if (profileSection) profileSection.style.display = 'block';

      const user = session.user;

      // 프로필 불러와 role 저장
      const { data: profile } = await supabase
        .from('profiles')
        .select('role, created_at, daily_limit')
        .eq('user_id', user.id)
        .single();

      const role = (profile?.role || 'normal').toLowerCase();
      localStorage.setItem('userRole', role); // 로그인 시 갱신
    } else {
      // 로그아웃 시 스토리지 정리
      localStorage.removeItem('authToken');
      sessionStorage.removeItem('authToken');
      localStorage.removeItem('userRole');

      if (authSection) authSection.style.display = 'block';
      if (profileSection) profileSection.style.display = 'none';
      if (nicknameEl) nicknameEl.textContent = '';
      if (historySection) historySection.style.display = 'none';
    }

    // add-btn 즉시 반영
    const addBtn = document.getElementById('add-btn');
    if (addBtn) {
      addBtn.style.display = getRole() === 'admin' ? 'inline' : 'none';
    }
  }

  // 초기/변경 동일 흐름으로 갱신
  (async function init() {
    // 초기엔 버튼 숨김(깜빡임 방지)
    const addBtn = document.getElementById('add-btn');
    if (addBtn) addBtn.style.display = 'none';

    const { data: { session } } = await supabase.auth.getSession();
    await updateAuthUI(session);   // role 저장/버튼 상태 갱신
    await renderNotices();         // role 반영 후 목록 렌더

    supabase.auth.onAuthStateChange(async (_event, newSession) => {
      await updateAuthUI(newSession); // 로그인/로그아웃마다 role 갱신
      await renderNotices();          // 그리고 목록 다시 렌더
    });
  })();
</script>



<!-- 관리자 메뉴관리 -->
<script>
  // role에 따라 요소 표시/숨김
  function showIfAdmin(selector) {
    const el = document.querySelector(selector);
    if (!el) return;
    const role = (localStorage.getItem('userRole') || 'normal').toLowerCase();
    el.style.display = role === 'admin' ? 'inline' : 'none';
  }
</script>





<!-- 리셋버튼작동 -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const resetBtn = document.getElementById("reset-btn");
  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      console.log("✅ 리셋 버튼 눌림");

      // ✅ 사주 입력 폼 전체 초기화
      const form = document.getElementById("saju-form");
      if (form) form.reset();

      // ✅ 출력 전체 숨기기 및 내용 지우기
      const resultContainer = document.getElementById("result");
      if (resultContainer) {
        resultContainer.style.display = "none";

        // 내부 내용도 싹 지움
        const birthInfo = document.getElementById("birth-info");
        if (birthInfo) birthInfo.innerHTML = "";

        const ganjiTable = document.getElementById("ganji-table");
        if (ganjiTable) ganjiTable.innerHTML = "";

        const todaySaju = document.getElementById("today-saju-container");
        if (todaySaju) todaySaju.innerHTML = "";

        const dangryeong = document.getElementById("dangryeong-table");
        if (dangryeong) dangryeong.innerHTML = "";

        const basicDaeyun = document.getElementById("basic-daeyun-table");
        if (basicDaeyun) basicDaeyun.innerHTML = "";

        const sinsalDaeyun = document.getElementById("sinsal-daeyun-table");
        if (sinsalDaeyun) sinsalDaeyun.innerHTML = "";

        const sinsalBox = document.getElementById("sinsal-box");
        if (sinsalBox) sinsalBox.innerHTML = "";

        const etcSinsalBox = document.getElementById("etc-sinsal-box");
        if (etcSinsalBox) etcSinsalBox.innerHTML = "";
      }

      // ✅ 히스토리 숨기기
      const historySection = document.getElementById("saju-history-section");
      if (historySection) historySection.style.display = "none";

      // ✅ 스크롤 맨 위로
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  } else {
    console.log("❌ reset-btn 버튼을 찾을 수 없음");
  }
});
</script>


<!-- 공지게시판목록 새창 띄우기 -->
<script>
  // 공지게시판 메뉴를 작은 팝업 창으로 열기
  document.querySelector('.top-menu a[href="/index.html"]')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.open(
      '/notice-list.html',
      'noticeWin',
      'width=900,height=650,menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes'
    );
  });
</script>

<script>
// 전화번호 포맷(있으면 사용)
function normPhone(v){
  const raw=(v||'').trim();
  if(!raw) return null;
  try{return typeof normalizePhoneKR==='function'?normalizePhoneKR(raw,"intl"):raw;}catch{return raw;}
}

// 패널 토글
function toggleProfilePanel(forceOpen) {
  const panel = document.getElementById('profile-edit-panel');
  if (!panel) { console.warn('[profile] panel not found'); return; }

  // 열기/닫기 결정
  const wantOpen = (forceOpen === undefined)
    ? !panel.classList.contains('open')
    : !!forceOpen;

  // 클래스 + display 함께 처리
  panel.classList.toggle('open', wantOpen);
  panel.setAttribute('aria-hidden', wantOpen ? 'false' : 'true');
  panel.style.display = wantOpen ? 'block' : 'none';

  console.log('[profile] togglePanel ->', wantOpen);
}


// 입력칸 채우기
async function fillMyProfileForm() {
  const { data: { user } } = await window.supabaseClient.auth.getUser();
  if (!user) return;

  // 프로필에서 기본 정보 가져오기
  const { data: profile, error } = await window.supabaseClient
    .from("profiles")
    .select("nickname, phone, grade, daily_limit, daily_usage_count")
    .eq("user_id", user.id)
    .maybeSingle();
  if (error) console.warn('[profile] load error', error);

  // 이메일은 auth.user에서
  const email = user.email || "";

  // 값 반영
  const nickEl   = document.getElementById("my-nickname");
  const emailEl  = document.getElementById("my-email");
  const phoneEl  = document.getElementById("my-phone");
  const gradeEl  = document.getElementById("my-grade");
  const countEl  = document.getElementById("my-daily-count");

  if (nickEl) {
    const nickVal = profile?.nickname ?? "";
    nickEl.value = nickVal;
    // 닉네임이 없을 때만 안내 멘트를 placeholder로
    nickEl.placeholder = nickVal.trim()
      ? "닉네임은 한 번 더 등록해주세요"
      : "닉네임은 한 번 더 등록해주세요";
  }

  if (emailEl) {
    emailEl.value = email;
    emailEl.readOnly = true; // 이메일 수정 불가
  }

  if (phoneEl) phoneEl.value = profile?.phone ?? "";

  const used  = profile?.daily_usage_count ?? 0;
  const limit = profile?.daily_limit ?? 0;
  if (gradeEl) gradeEl.textContent = profile?.grade ?? "-";
  if (countEl) countEl.textContent = limit ? `${used}/${limit}` : `${used}/-`;

  // ※ 플랜 B: 일일 카운트/리밋이 saju_counts에 있을 경우 보정
  if (!limit) {
    const { data: sc } = await window.supabaseClient
      .from("saju_counts")
      .select("used_today, daily_limit")
      .eq("user_id", user.id)
      .maybeSingle();
    const used2 = sc?.used_today ?? used;
    const lim2  = sc?.daily_limit ?? limit;
    if (countEl) countEl.textContent = lim2 ? `${used2}/${lim2}` : `${used2}/-`;
  }
}


// 저장
async function saveMyProfile() {
  const { data: { user } } = await window.supabaseClient.auth.getUser();
  if (!user) { alert("로그인이 필요합니다."); return; }

  // 입력값
  const nickname = document.getElementById("my-nickname")?.value?.trim() || null;
  const newEmail = document.getElementById("my-email")?.value?.trim() || null;
  const phone    = (function normPhone(v) {
    const raw = (v || '').trim();
    if (!raw) return null;
    try { return typeof normalizePhoneKR === 'function' ? normalizePhoneKR(raw, "intl") : raw; }
    catch { return raw; }
  })(document.getElementById("my-phone")?.value || "");

  // 1) 프로필 업데이트 (닉네임/전화번호)
  const { error: pErr } = await window.supabaseClient
    .from("profiles")
    .update({ nickname, phone })
    .eq("user_id", user.id);
  if (pErr) {
    alert("프로필 저장 실패: " + (pErr.message || "오류"));
    return;
  }

  // 2) 이메일 변경이 있으면 auth 계정 이메일 업데이트
  //    (주의: 구글/카카오 등 소셜 로그인 계정은 이메일 변경이 제한될 수 있음)
  if (newEmail && newEmail !== (user.email || "")) {
    const { data, error: eErr } = await window.supabaseClient.auth.updateUser({ email: newEmail });
    if (eErr) {
      alert("이메일 변경 실패: " + (eErr.message || "오류"));
      // 이메일만 실패했어도 닉네임/전화번호는 이미 저장됨
    } else {
      // 이메일 변경은 확인 메일이 갈 수 있음 (Supabase 프로젝트 설정에 따름)
      console.log('[profile] email update result:', data);
    }
  }

  alert("저장 완료");

  // 상단 닉네임/버튼 등 갱신
  const { data: sess } = await window.supabaseClient.auth.getSession();
  if (sess?.session) { updateAuthUI(sess.session); }

  toggleProfilePanel(false);
}

// 이벤트 바인딩(중복 방지)
function wireProfileEditEvents() {
  const editBtn   = document.getElementById("editProfileBtn");
  const saveBtn   = document.getElementById("my-profile-save");
  const cancelBtn = document.getElementById("my-profile-cancel");

  if (editBtn && !editBtn.dataset.bound) {
    editBtn.addEventListener("click", async () => {
      console.log('[profile] edit clicked'); // ← 클릭 확인
      const { data: { user } } = await window.supabaseClient.auth.getUser();
      if (!user) { alert("로그인이 필요합니다."); return; }
      await fillMyProfileForm();   // 폼 채우기
      toggleProfilePanel(true);    // 열기
    });
    editBtn.dataset.bound = "1";
  }

  if (saveBtn && !saveBtn.dataset.bound) {
    saveBtn.addEventListener("click", saveMyProfile);
    saveBtn.dataset.bound = "1";
  }

  if (cancelBtn && !cancelBtn.dataset.bound) {
    cancelBtn.addEventListener("click", () => {
      console.log('[profile] cancel clicked');
      toggleProfilePanel(false);
    });
    cancelBtn.dataset.bound = "1";
  }
}


// 초기화 시 한 번 호출
document.addEventListener("DOMContentLoaded", ()=>{ wireProfileEditEvents(); });

// 로그인 성공 후 UI 갱신 시에도 다시 보강 호출
// updateAuthUI(session) 내부의 로그인 분기 끝부분에 아래 한 줄을 추가해 두세요:
//   wireProfileEditEvents();
</script>



</body>
</html>




