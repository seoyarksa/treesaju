<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Kakao ì •ê¸°êµ¬ë… ê²°ì œ</title>
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
  <h3>Kakao ì •ê¸°êµ¬ë… ê²°ì œ</h3>
  <button id="payBtn">ê²°ì œí•˜ê¸°</button>

  <script>
  // âœ… 1. ì•„ì„í¬íŠ¸ ê°ì²´ ì´ˆê¸°í™”
  const IMP = window.IMP;
  IMP.init("store-0d3b8b48-ae3c-4bd3-bcaf-56ffb3fece6f"); // ğŸ‘‰ ë³¸ì¸ ì•„ì„í¬íŠ¸ ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¡œ êµì²´

  // âœ… 2. ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
  document.getElementById("payBtn").addEventListener("click", async function() {
    try {
      // Supabase ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸ (user_id í•„ìš”)
      const { data: { user } } = await window.supabaseClient.auth.getUser();
      if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const userId = user.id; // Supabase user_id
      const customerUid = "kakao_" + userId; // ê° ì‚¬ìš©ì ê³ ìœ  ë¹Œë§ UID

      // âœ… 3. ê²°ì œ ìš”ì²­
      IMP.request_pay({
        pg: "kakaopay.TC0ONETIME",  // í…ŒìŠ¤íŠ¸ìš© PG
        pay_method: "card",
        merchant_uid: "order_" + new Date().getTime(), // ì£¼ë¬¸ ê³ ìœ ë²ˆí˜¸
        name: "Kakao ì •ê¸°êµ¬ë… (ì›”ê°„)",
        amount: 11000,
        customer_uid: customerUid, // âœ… ì‚¬ìš©ì ê³ ìœ  ì‹ë³„ì
        buyer_email: user.email || "user@example.com",
        buyer_name: "í™ê¸¸ë™",
        buyer_tel: "01012345678"
      }, async function (rsp) {
        // âœ… 4. ê²°ì œ ì½œë°± ì²˜ë¦¬
        if (rsp.success) {
          alert("ê²°ì œ ì„±ê³µ ğŸ‰\nê²°ì œë²ˆí˜¸: " + rsp.imp_uid);

          try {
            // âœ… 5. ì„œë²„ì— ë¹Œë§ ì •ë³´ ë“±ë¡
            const res = await fetch("/api/payment/register-billing", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                imp_uid: rsp.imp_uid,
                customer_uid: rsp.customer_uid, // ì•„ì„í¬íŠ¸ê°€ ì „ë‹¬í•œ UID
                user_id: userId
              }),
            });

            const data = await res.json();
            if (res.ok) {
              console.log("âœ… ì„œë²„ ì‘ë‹µ:", data);
              alert("ì •ê¸°ê²°ì œ ë“±ë¡ ì™„ë£Œ âœ…");
            } else {
              console.error("âŒ ì„œë²„ ì˜¤ë¥˜:", data);
              alert("ì„œë²„ ë“±ë¡ ì‹¤íŒ¨ âŒ: " + (data.error || "ì„œë²„ ì˜¤ë¥˜"));
            }
          } catch (err) {
            console.error("[register-billing fetch error]", err);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ âŒ: " + err.message);
          }

        } else {
          alert("ê²°ì œ ì‹¤íŒ¨ âŒ\n" + rsp.error_msg);
        }
      });
    } catch (e) {
      console.error("[Kakao Pay Error]", e);
      alert("ë‚´ë¶€ ì˜¤ë¥˜: " + e.message);
    }
  });
</script>

</body>
</html>
