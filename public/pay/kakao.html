<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Kakao ì •ê¸°êµ¬ë… ê²°ì œ</title>
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <!-- âœ… Supabase í´ë¼ì´ì–¸íŠ¸ SDK ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h3>Kakao ì •ê¸°êµ¬ë… ê²°ì œ</h3>
  <button id="payBtn">ê²°ì œí•˜ê¸°</button>

  <script>
    // âœ… 1. Supabase ì´ˆê¸°í™”
    const supabaseUrl = "https://dxrgobsgeeshkybkbnxo.supabase.co"; // âœ… ë³¸ì¸ í”„ë¡œì íŠ¸ URL
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cmdvYnNnZWVzaGt5YmtibnhvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODA5MDI3MiwiZXhwIjoyMDczNjY2MjcyfQ.CHwKj-HrhScDsgxVd9oTy4f77CeWrKiejO0nRBW4GKQ";         // âœ… Supabase anon key
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    // âœ… 2. ì•„ì„í¬íŠ¸ ê°ì²´ ì´ˆê¸°í™”
    const IMP = window.IMP;
    IMP.init("store-0d3b8b48-ae3c-4bd3-bcaf-56ffb3fece6f"); // ë³¸ì¸ ê°€ë§¹ì  ì‹ë³„ì½”ë“œ

    // âœ… 3. ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    document.getElementById("payBtn").addEventListener("click", async function () {
      try {
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
        const { data: { user }, error } = await window.supabaseClient.auth.getUser();
        if (error || !user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        const userId = user.id;
        const customerUid = "kakao_" + userId;

        // âœ… 4. ê²°ì œ ìš”ì²­
        IMP.request_pay({
          pg: "kakaopay.TC0ONETIME", // í…ŒìŠ¤íŠ¸ìš© ì¹´ì¹´ì˜¤í˜ì´
          pay_method: "card",
          merchant_uid: "order_" + new Date().getTime(),
          name: "Kakao ì •ê¸°êµ¬ë… (ì›”ê°„)",
          amount: 11000,
          customer_uid: customerUid,
          buyer_email: user.email || "user@example.com",
          buyer_name: "í™ê¸¸ë™",
          buyer_tel: "01012345678",
        }, async function (rsp) {
          // âœ… 5. ê²°ì œ ì½œë°±
          if (rsp.success) {
            alert("ê²°ì œ ì„±ê³µ ğŸ‰\nê²°ì œë²ˆí˜¸: " + rsp.imp_uid);

            try {
              const res = await fetch("/api/payment/register-billing", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  imp_uid: rsp.imp_uid,
                  customer_uid: rsp.customer_uid || customerUid,
                  user_id: userId,
                }),
              });

              const data = await res.json();
              if (res.ok) {
                console.log("âœ… ì„œë²„ ì‘ë‹µ:", data);
                alert("ì •ê¸°ê²°ì œ ë“±ë¡ ì™„ë£Œ âœ…");
              } else {
                console.error("âŒ ì„œë²„ ì˜¤ë¥˜:", data);
                alert("ì„œë²„ ë“±ë¡ ì‹¤íŒ¨ âŒ: " + (data.error || "ì„œë²„ ì˜¤ë¥˜"));
              }
            } catch (err) {
              console.error("[register-billing fetch error]", err);
              alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ âŒ: " + err.message);
            }
          } else {
            alert("ê²°ì œ ì‹¤íŒ¨ âŒ\n" + rsp.error_msg);
          }
        });
      } catch (e) {
        console.error("[Kakao Pay Error]", e);
        alert("ë‚´ë¶€ ì˜¤ë¥˜: " + e.message);
      }
    });
  </script>
</body>
</html>
